<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive PSI Visualization</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { font-family: Arial, sans-serif; background-color: #e8f5e9; padding: 20px; }
        .container { background-color: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1 { color: #2e7d32; text-align: center; margin-bottom: 20px; }
        #map, #chart { width: 100%; height: 400px; margin-bottom: 30px; }
        .region { stroke: #fff; stroke-width: 1px; }
        .axis { font-size: 12px; }
        .tooltip { position: absolute; background-color: white; padding: 5px; border: 1px solid #ddd; border-radius: 5px; pointer-events: none; display: none; }
        #controls { margin-bottom: 20px; }
        .footer { text-align: center; margin-top: 20px; font-size: 14px; color: #666; }
        #data-table { margin-top: 30px; width: 100%; }
        #data-table th { background-color: #4caf50; color: white; cursor: pointer; }
        #data-table td { transition: background-color 0.3s ease; }
        #data-table tr:hover td { background-color: #e8f5e9; }
        th.sort-asc::after { content: " ▲"; }
        th.sort-desc::after { content: " ▼"; }
        .logo-container { position: absolute; top: 20px; left: 20px; }
        .college-logo { width: 100px; height: auto; }
        .center { margin-left: auto; margin-right: auto; }
        .loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: none; }
    </style>
</head>
<body>
    <div class="logo-container">
        <img src="https://lkycic.sutd.edu.sg/wp-content/uploads/2023/03/lkycic-logo-web-2022-fc-full-1x.png" alt="College Logo" class="college-logo"> 
    </div>
    <div class="container">
        <h1>Singapore PSI Visualization</h1>
        <div id="controls" class="row">
            <div class="col">
                <label for="metricSelect">Select Metric:</label>
                <select id="metricSelect" class="form-select">
                    <option value="psi_twenty_four_hourly">PSI (24 Hour)</option>
                    <option value="pm10_sub_index">PM10</option>
                    <option value="pm25_sub_index">PM2.5</option>
                </select>
            </div>
            <div class="col">
                <label for="regionSelect">Select Region:</label>
                <select id="regionSelect" class="form-select">
                    <option value="all">All Regions</option>
                    <option value="central">Central</option>
                    <option value="west">West</option>
                    <option value="east">East</option>
                    <option value="north">North</option>
                    <option value="south">South</option>
                </select>
            </div>
            <div class="col">
                <label for="dateSelect">Select Date:</label>
                <input type="date" id="dateSelect" class="form-control" value="">
            </div>
        </div>
        <div class="loading">Loading...</div>
        <div id="map"></div>
        <div id="chart"></div>
        <div id="data-table" class="table-responsive"></div>
        <div class="footer">
            <p>Baorong Li - 1009456</p>
        </div>
    </div>

    <script>
        const width = 960, height = 400;
        const margin = { top: 20, right: 30, bottom: 30, left: 60 };
        let psiData = [];
        let selectedMetric = "psi_twenty_four_hourly";
        let selectedRegion = "all";
        let selectedDate = new Date().toISOString().split('T')[0]; // Default to today's date

        document.getElementById('dateSelect').value = selectedDate; // Set the input's default value to today's date

        // Initialize the map and chart SVG elements
        const mapSvg = d3.select("#map").append("svg")
            .attr("width", width)
            .attr("height", height)
            .attr("class", "center");

        const chartSvg = d3.select("#chart").append("svg")
            .attr("width", width)
            .attr("height", height)
            .attr("class", "center");

        const colorScale = d3.scaleSequential(d3.interpolateGreens).domain([0, 100]);

        // Load and display the initial data and map
       d3.json("https://raw.githubusercontent.com/carionb/HASS-assignment1/main/sgmap.json").then(data => {
        const singapore = topojson.feature(data, data.objects.sg);  // Make sure the 'sg' is the correct object key
        mapSvg.selectAll("path")
            .data(singapore.features)
            .enter().append("path")
            .attr("d", path)
            .attr("class", "region")
            .attr("fill", d => colorScale(Math.random() * 100)); // Random coloring for demo purposes
    }).catch(error => {
        console.error('Error loading the GeoJSON data:', error);
    });

        function updateVisualization() {
            document.querySelector('.loading').style.display = 'block'; // Show loading indicator
            fetch(`https://api.data.gov.sg/v1/environment/psi?date=${selectedDate}`)
                .then(response => response.json())
                .then(data => {
                    document.querySelector('.loading').style.display = 'none'; // Hide loading indicator
                    psiData = data.items;
                    updateMap();
                    updateLineChart();
                    updateDataTable();
                })
                .catch(error => {
                    console.error('Error loading the PSI data:', error);
                    document.querySelector('.loading').style.display = 'none'; // Hide loading indicator
                });
        }

        function updateMap() {
            // Implement map update logic
        }

        function updateLineChart() {
            // Implement chart update logic
        }

        function updateDataTable() {
            // Implement data table update logic
        }

        document.addEventListener('DOMContentLoaded', function() {
            updateVisualization();
            setInterval(updateVisualization, 300000); // Update every 5 minutes
        });

        // Add event listeners for the controls
        d3.select("#metricSelect").on("change", function() {
            selectedMetric = this.value;
            updateVisualization();
        });

        d3.select("#regionSelect").on("change", function() {
            selectedRegion = this.value;
            updateLineChart();
        });

        d3.select("#dateSelect").on("change", function() {
            selectedDate = this.value;
            updateVisualization();
        });
    </script>
</body>
</html>
