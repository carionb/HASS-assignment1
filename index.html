<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Interactive PSI Visualization</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { font-family: Arial, sans-serif; background-color: #e8f5e9; padding: 20px; }
        .container { background-color: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1 { color: #2e7d32; text-align: center; margin-bottom: 20px; }
        #map { width: 100%; height: 400px; margin-bottom: 30px; }
        .region { stroke: #fff; stroke-width: 1px; }
        #chart { width: 100%; height: 300px; margin-bottom: 30px; }
        .line { fill: none; stroke-width: 2px; }
        .axis { font-size: 12px; }
        .tooltip { position: absolute; background-color: white; padding: 5px; border: 1px solid #ddd; border-radius: 5px; pointer-events: none; }
        #controls { margin-bottom: 20px; }
        .footer { text-align: center; margin-top: 20px; font-size: 14px; color: #666; }
        #data-table { margin-top: 30px; }
        #data-table th { background-color: #4caf50; color: white; cursor: pointer; }
        #data-table td { transition: background-color 0.3s ease; }
        #data-table tr:hover td { background-color: #e8f5e9; }
        th.sort-asc::after { content: " ▲"; }
        th.sort-desc::after { content: " ▼"; }
        .logo-container { position: absolute; top: 20px; left: 20px; }
        .college-logo { width: 100px; height: auto; }
    </style>
</head>
<body>
    <div class="logo-container">
        <img src="https://lkycic.sutd.edu.sg/wp-content/uploads/2023/03/lkycic-logo-web-2022-fc-full-1x.png" alt="College Logo" class="college-logo">
    </div>
    <div class="container">
        <h1>Singapore PSI Visualization</h1>
        <div id="controls" class="row">
            <div class="col">
                <label for="metricSelect">Select Metric:</label>
                <select id="metricSelect" class="form-select">
                    <option value="psi_twenty_four_hourly">PSI (24 Hour)</option>
                    <option value="pm10_sub_index">PM10</option>
                    <option value="pm25_sub_index">PM2.5</option>
                </select>
            </div>
            <div class="col">
                <label for="regionSelect">Select Region:</label>
                <select id="regionSelect" class="form-select">
                    <option value="all">All Regions</option>
                    <option value="central">Central</option>
                    <option value="west">West</option>
                    <option value="east">East</option>
                    <option value="north">North</option>
                    <option value="south">South</option>
                </select>
            </div>
            <div class="col">
                <label for="dateSelect">Select Date:</label>
                <input type="date" id="dateSelect" class="form-control">
            </div>
        </div>
        <div id="map"></div>
        <div id="chart"></div>
        <div id="data-table"></div>
        <div class="footer">
            <p>Baorong Li - 1009456</p>
        </div>
    </div>

    <script>
        const width = 800;
        const height = 400;
        const margin = {top: 20, right: 30, bottom: 30, left: 60};
        let psiData = [];
        let selectedMetric = "psi_twenty_four_hourly";
        let selectedRegion = "all";
        let selectedDate = new Date().toISOString().split('T')[0];

        const mapSvg = d3.select("#map")
            .append("svg")
            .attr("width", width)
            .attr("height", height);

        const chartSvg = d3.select("#chart")
            .append("svg")
            .attr("width", width)
            .attr("height", height);

        const colorScale = d3.scaleSequential(d3.interpolateGreens)
            .domain([0, 100]);

        d3.json("https://raw.githubusercontent.com/your-github-username/singapore-map/main/singapore.json").then(data => {
            const singapore = topojson.feature(data, data.objects.singapore);
            
            const projection = d3.geoMercator().fitSize([width, height], singapore);
            const path = d3.geoPath().projection(projection);

            mapSvg.selectAll("path")
                .data(singapore.features)
                .enter()
                .append("path")
                .attr("d", path)
                .attr("class", "region")
                .attr("fill", "#ccc");
        });

        function updateVisualization() {
            d3.json(`https://api.data.gov.sg/v1/environment/psi?date=${selectedDate}`).then(data => {
                psiData = data.items;
                updateMap();
                updateLineChart();
                updateDataTable();
            });
        }

        function updateMap() {
            const latestData = psiData[psiData.length - 1].readings[selectedMetric];

            mapSvg.selectAll(".region")
                .transition()
                .duration(1000)
                .attr("fill", d => {
                    const regionName = d.properties.name.toLowerCase();
                    return colorScale(latestData[regionName]);
                });
        }

        function updateLineChart() {
            chartSvg.selectAll("*").remove();

            const chartData = psiData.map(item => ({
                timestamp: new Date(item.timestamp),
                value: item.readings[selectedMetric][selectedRegion === "all" ? "national" : selectedRegion]
            }));

            const x = d3.scaleTime()
                .range([margin.left, width - margin.right])
                .domain([d3.timeDay.floor(chartData[0].timestamp), d3.timeDay.ceil(chartData[chartData.length - 1].timestamp)]);

            const y = d3.scaleLinear()
                .range([height - margin.bottom, margin.top])
                .domain([0, d3.max(chartData, d => d.value)]);

            const line = d3.line()
                .x(d => x(d.timestamp))
                .y(d => y(d.value));

            chartSvg.append("g")
                .attr("transform", `translate(0,${height - margin.bottom})`)
                .call(d3.axisBottom(x).ticks(24).tickFormat(d3.timeFormat("%H:00")));

            chartSvg.append("g")
                .attr("transform", `translate(${margin.left},0)`)
                .call(d3.axisLeft(y));

            const path = chartSvg.append("path")
                .datum(chartData)
                .attr("class", "line")
                .attr("d", line)
                .attr("fill", "none")
                .attr("stroke", "#2e7d32")
                .attr("stroke-width", 2);

            const totalLength = path.node().getTotalLength();
            path
                .attr("stroke-dasharray", totalLength + " " + totalLength)
                .attr("stroke-dashoffset", totalLength)
                .transition()
                .duration(2000)
                .ease(d3.easeLinear)
                .attr("stroke-dashoffset", 0);

            const tooltip = d3.select("body").append("div")
                .attr("class", "tooltip")
                .style("opacity", 0);

            chartSvg.selectAll("dot")
                .data(chartData)
                .enter().append("circle")
                .attr("r", 5)
                .attr("cx", d => x(d.timestamp))
                .attr("cy", d => y(d.value))
                .on("mouseover", (event, d) => {
                    tooltip.transition()
                        .duration(200)
                        .style("opacity", .9);
                    tooltip.html(`Time: ${d.timestamp.toLocaleString()}<br/>Value: ${d.value}`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", () => {
                    tooltip.transition()
                        .duration(500)
                        .style("opacity", 0);
                });
        }

        function updateDataTable() {
            const tableData = psiData.map(item => ({
                timestamp: new Date(item.timestamp).toLocaleString(),
                ...Object.entries(item.readings[selectedMetric]).reduce((acc, [key, value]) => {
                    acc[key] = value;
                    return acc;
                }, {})
            }));

            const table = d3.select("#data-table")
                .html("")
                .append("table")
                .attr("class", "table table-striped");

            const headers = ["Timestamp", "Central", "West", "East", "North", "South", "National"];

            const thead = table.append("thead").append("tr");
            thead.selectAll("th")
                .data(headers)
                .enter()
                .append("th")
                .text(d => d)
                .on("click", function(event, d) {
                    const isAscending = this.classList.contains("sort-asc");
                    thead.selectAll("th").classed("sort-asc", false).classed("sort-desc", false);
                    this.classList.add(isAscending ? "sort-desc" : "sort-asc");
                    
                    tableData.sort((a, b) => {
                        return isAscending ? b[d.toLowerCase()] - a[d.toLowerCase()] : a[d.toLowerCase()] - b[d.toLowerCase()];
                    });
                    updateRows();
                });

            const tbody = table.append("tbody");

            function updateRows() {
                const rows = tbody.selectAll("tr")
                    .data(tableData)
                    .join("tr")
                    .on("mouseover", function() {
                        d3.select(this).transition().duration(300).style("background-color", "#e8f5e9");
                    })
                    .on("mouseout", function() {
                        d3.select(this).transition().duration(300).style("background-color", "");
                    });

                rows.selectAll("td")
                    .data(d => [d.timestamp, d.central, d.west, d.east, d.north, d.south, d.national])
                    .join("td")
                    .text(d => d);
            }

            updateRows();
        }

        d3.select("#metricSelect").on("change", function() {
            selectedMetric = this.value;
            updateVisualization();
        });

        d3.select("#regionSelect").on("change", function() {
            selectedRegion = this.value;
            updateLineChart();
        });

        d3.select("#dateSelect").on("change", function() {
            selectedDate = this.value;
            updateVisualization();
        });

        updateVisualization();
        setInterval(updateVisualization, 300000);
    </script>
</body>
</html>
